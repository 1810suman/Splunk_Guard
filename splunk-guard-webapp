import streamlit as st
import pandas as pd
import requests
import plotly.express as px
from requests.auth import HTTPBasicAuth

# ---- SPLUNK CONFIGURATION ----
SPLUNK_HOST = "https://localhost:8089"   # Replace with your Splunk Management Port
USERNAME = "your_username"                   # Your Splunk username
PASSWORD = "your_password"                   # Your Splunk password

# Disable SSL Warnings for self-signed certs
requests.packages.urllib3.disable_warnings()

# ---- Function to Query Splunk REST API ----
def splunk_search(query):
    search_url = f"{SPLUNK_HOST}/services/search/jobs"
    headers = {"Content-Type": "application/x-www-form-urlencoded"}
    payload = {
        "search": f"search {query}",
        "exec_mode": "blocking",
        "output_mode": "json"
    }

    response = requests.post(search_url, auth=HTTPBasicAuth(USERNAME, PASSWORD),
                             headers=headers, data=payload, verify=False)
    
    if response.status_code != 201:
        st.error(f"Search failed: {response.text}")
        return pd.DataFrame()

    sid = response.json().get("sid")
    results_url = f"{SPLUNK_HOST}/services/search/jobs/{sid}/results?output_mode=json"
    
    result = requests.get(results_url, auth=HTTPBasicAuth(USERNAME, PASSWORD), verify=False)
    
    if result.status_code != 200:
        st.error("Failed to fetch results.")
        return pd.DataFrame()

    rows = result.json().get("results", [])
    return pd.DataFrame(rows)

# ---- Streamlit Dashboard ----
st.set_page_config(page_title="Splunk-Guard Threat Monitor", layout="wide")
st.title("üîê Splunk-Guard: Real-Time Threat Monitoring Dashboard")

# ---- Data Selection ----
st.sidebar.header("Select Data Type to Analyze")
data_choice = st.sidebar.selectbox("Choose Data Type", ["USB Data", "VPN Data"])

# ---- USB Data Section ----
if data_choice == "USB Data":
    st.header("üìä USB Write Volume Over Time")

    usb_data = splunk_search(
        r'index=splunk_guard sourcetype=usb_logs '
        r'| rex field=_raw "^(?<device_id>[^,]+),(?<bytes_written>\d+),(?<timestamp>.+)$" '
        r'| eval bytes_written=tonumber(bytes_written) '
        r'| timechart span=1h sum(bytes_written) as total_written'
    )

    if not usb_data.empty:
        usb_data["time"] = pd.to_datetime(usb_data["_time"])
        fig = px.line(usb_data, x="time", y="total_written",
                      title="Hourly USB Write Volume", markers=True)
        st.plotly_chart(fig, use_container_width=True)
    else:
        st.warning("No USB data available or Splunk query returned empty results.")

# ---- VPN Data Section ----
if data_choice == "VPN Data":
    st.header("üåç VPN Login Distribution")

    # Pie Chart by Country
    vpn_country_data = splunk_search(
        r'index=vpn sourcetype=vpn | stats count by country'
    )
    if not vpn_country_data.empty:
        fig = px.pie(vpn_country_data, names='country', values='count',
                     title="VPN Logins by Country")
        st.plotly_chart(fig, use_container_width=True)
    else:
        st.warning("No VPN country data available.")

    # Bar Chart by Username
    st.subheader("üë§ VPN Logins by Username")

    vpn_user_data = splunk_search(
        r'index=vpn sourcetype=vpn | stats count by username'
    )
    if not vpn_user_data.empty:
        fig = px.bar(vpn_user_data, x='username', y='count',
                     title="VPN Logins by User", color='count')
        st.plotly_chart(fig, use_container_width=True)
    else:
        st.warning("No VPN login data available.")

# ---- Footer ----
st.info("‚ö° This dashboard fetches live threat monitoring data from Splunk via REST API.")
